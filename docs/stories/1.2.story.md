# Story 1.2: Create AudioManager Singleton

**Epic:** Epic 1 - Foundation & Setup
**Story ID:** 1.2
**Priority:** High
**Points:** 3
**Status:** Draft

---

## Description

Implement a centralized AudioManager singleton to manage all game audio (sound effects and background music). The manager provides a clean API for playing sounds, managing volume levels, and persisting audio settings across sessions. This foundational system enables sound integration in Epic 2 (gameplay sounds) and Epic 7 (full audio polish).

**GDD Reference:** Architecture > Core Manager Singletons (Epic 1 Deliverable)

This story establishes the audio infrastructure required before implementing gameplay sound effects (seed sowing, captures) and UI audio feedback.

---

## Acceptance Criteria

### Functional Requirements

- [ ] **AC1:** AudioManager exists as singleton MonoBehaviour, persists across scenes (DontDestroyOnLoad)
- [ ] **AC2:** Play sound effect method: `PlaySFX(AudioClip clip, float volume = 1.0f)`
- [ ] **AC3:** Play background music method: `PlayMusic(AudioClip clip, bool loop = true, float volume = 0.5f)`
- [ ] **AC4:** Stop music method: `StopMusic(float fadeOutDuration = 0.5f)`
- [ ] **AC5:** Volume control methods: `SetSFXVolume(float volume)`, `SetMusicVolume(float volume)`
- [ ] **AC6:** Mute toggle methods: `SetSFXMuted(bool muted)`, `SetMusicMuted(bool muted)`
- [ ] **AC7:** Settings persist across sessions using PlayerPrefs
- [ ] **AC8:** AudioManager initializes on Boot scene load, ready for use in MainMenu scene

### Technical Requirements

- [ ] **TR1:** Uses Unity AudioSource components (1 for music, pooled AudioSources for SFX)
- [ ] **TR2:** Follows singleton pattern from architecture coding standards
- [ ] **TR3:** No memory leaks (AudioSources properly pooled and released)
- [ ] **TR4:** Thread-safe volume changes (can be called from any script)
- [ ] **TR5:** SerializeField for max simultaneous SFX (default: 10)

### Game Design Requirements

- [ ] **GD1:** Default music volume: 50% (0.5f) to avoid overpowering gameplay
- [ ] **GD2:** Default SFX volume: 100% (1.0f) for clear audio feedback
- [ ] **GD3:** Music fades out smoothly (0.5s) to avoid jarring stops

---

## Technical Specifications

### Files to Create/Modify

**New Files:**

- `Assets/_Project/Scripts/Managers/AudioManager.cs` - Audio manager singleton

**Modified Files:**

- `Assets/_Project/Scenes/Boot.unity` - Add AudioManager GameObject
- (Future) `Assets/_Project/Scripts/UI/SettingsUI.cs` - Will integrate audio toggles (Epic 5)

### Class Definition

```csharp
// AudioManager.cs
using UnityEngine;
using System.Collections.Generic;
using DG.Tweening; // For music fade effects

namespace SocialOwareAcademy.Managers
{
    /// <summary>
    /// Centralized audio management for sound effects and background music.
    /// Singleton pattern, persists across scenes.
    /// </summary>
    public class AudioManager : MonoBehaviour
    {
        public static AudioManager Instance { get; private set; }

        [Header("Audio Sources")]
        [SerializeField] private AudioSource musicSource;
        [SerializeField] private int maxSimultaneousSFX = 10;

        [Header("Default Volumes")]
        [SerializeField] private float defaultMusicVolume = 0.5f;
        [SerializeField] private float defaultSFXVolume = 1.0f;

        // SFX object pool
        private Queue<AudioSource> sfxPool = new Queue<AudioSource>();
        private List<AudioSource> activeSFX = new List<AudioSource>();

        // Volume settings
        private float currentMusicVolume;
        private float currentSFXVolume;
        private bool isMusicMuted;
        private bool isSFXMuted;

        // PlayerPrefs keys
        private const string MUSIC_VOLUME_KEY = "Audio_MusicVolume";
        private const string SFX_VOLUME_KEY = "Audio_SFXVolume";
        private const string MUSIC_MUTED_KEY = "Audio_MusicMuted";
        private const string SFX_MUTED_KEY = "Audio_SFXMuted";

        void Awake()
        {
            // Singleton pattern
            if (Instance != null && Instance != this)
            {
                Destroy(gameObject);
                return;
            }

            Instance = this;
            DontDestroyOnLoad(gameObject);

            // Initialize audio sources
            InitializeAudioSources();

            // Load saved settings
            LoadAudioSettings();

            Debug.Log("[AudioManager] Initialized");
        }

        private void InitializeAudioSources()
        {
            // Create music source if not assigned
            if (musicSource == null)
            {
                musicSource = gameObject.AddComponent<AudioSource>();
                musicSource.loop = true;
                musicSource.playOnAwake = false;
            }

            // Pre-create SFX AudioSource pool
            for (int i = 0; i < maxSimultaneousSFX; i++)
            {
                AudioSource sfx = gameObject.AddComponent<AudioSource>();
                sfx.playOnAwake = false;
                sfx.loop = false;
                sfxPool.Enqueue(sfx);
            }
        }

        private void LoadAudioSettings()
        {
            currentMusicVolume = PlayerPrefs.GetFloat(MUSIC_VOLUME_KEY, defaultMusicVolume);
            currentSFXVolume = PlayerPrefs.GetFloat(SFX_VOLUME_KEY, defaultSFXVolume);
            isMusicMuted = PlayerPrefs.GetInt(MUSIC_MUTED_KEY, 0) == 1;
            isSFXMuted = PlayerPrefs.GetInt(SFX_MUTED_KEY, 0) == 1;

            ApplyMusicVolume();
        }

        private void SaveAudioSettings()
        {
            PlayerPrefs.SetFloat(MUSIC_VOLUME_KEY, currentMusicVolume);
            PlayerPrefs.SetFloat(SFX_VOLUME_KEY, currentSFXVolume);
            PlayerPrefs.SetInt(MUSIC_MUTED_KEY, isMusicMuted ? 1 : 0);
            PlayerPrefs.SetInt(SFX_MUTED_KEY, isSFXMuted ? 1 : 0);
            PlayerPrefs.Save();
        }

        /// <summary>
        /// Play a sound effect.
        /// </summary>
        public void PlaySFX(AudioClip clip, float volume = 1.0f)
        {
            if (clip == null || isSFXMuted)
                return;

            AudioSource source = GetAvailableSFXSource();
            if (source != null)
            {
                source.clip = clip;
                source.volume = volume * currentSFXVolume;
                source.Play();
            }
            else
            {
                Debug.LogWarning($"[AudioManager] Max simultaneous SFX reached ({maxSimultaneousSFX})");
            }
        }

        /// <summary>
        /// Play background music with optional loop.
        /// </summary>
        public void PlayMusic(AudioClip clip, bool loop = true, float volume = 0.5f)
        {
            if (clip == null)
                return;

            musicSource.clip = clip;
            musicSource.loop = loop;
            musicSource.volume = isMusicMuted ? 0f : volume * currentMusicVolume;
            musicSource.Play();
        }

        /// <summary>
        /// Stop background music with fade out.
        /// </summary>
        public void StopMusic(float fadeOutDuration = 0.5f)
        {
            if (musicSource.isPlaying)
            {
                musicSource.DOFade(0f, fadeOutDuration).OnComplete(() =>
                {
                    musicSource.Stop();
                    musicSource.volume = currentMusicVolume; // Reset for next play
                });
            }
        }

        /// <summary>
        /// Set music volume (0.0 to 1.0).
        /// </summary>
        public void SetMusicVolume(float volume)
        {
            currentMusicVolume = Mathf.Clamp01(volume);
            ApplyMusicVolume();
            SaveAudioSettings();
        }

        /// <summary>
        /// Set SFX volume (0.0 to 1.0).
        /// </summary>
        public void SetSFXVolume(float volume)
        {
            currentSFXVolume = Mathf.Clamp01(volume);
            SaveAudioSettings();
        }

        /// <summary>
        /// Mute/unmute music.
        /// </summary>
        public void SetMusicMuted(bool muted)
        {
            isMusicMuted = muted;
            ApplyMusicVolume();
            SaveAudioSettings();
        }

        /// <summary>
        /// Mute/unmute sound effects.
        /// </summary>
        public void SetSFXMuted(bool muted)
        {
            isSFXMuted = muted;
            SaveAudioSettings();
        }

        private void ApplyMusicVolume()
        {
            musicSource.volume = isMusicMuted ? 0f : currentMusicVolume;
        }

        private AudioSource GetAvailableSFXSource()
        {
            // Recycle finished SFX sources
            for (int i = activeSFX.Count - 1; i >= 0; i--)
            {
                if (!activeSFX[i].isPlaying)
                {
                    sfxPool.Enqueue(activeSFX[i]);
                    activeSFX.RemoveAt(i);
                }
            }

            // Get source from pool
            if (sfxPool.Count > 0)
            {
                AudioSource source = sfxPool.Dequeue();
                activeSFX.Add(source);
                return source;
            }

            return null; // Pool exhausted
        }

        // Public getters for UI
        public float MusicVolume => currentMusicVolume;
        public float SFXVolume => currentSFXVolume;
        public bool IsMusicMuted => isMusicMuted;
        public bool IsSFXMuted => isSFXMuted;
    }
}
```

### Integration Points

**Boot Scene Setup:**

1. Create empty GameObject named "AudioManager" in Boot scene
2. Attach `AudioManager.cs` script
3. Leave all fields default (AudioSource will be created at runtime)

**Usage Example (Future Stories):**

```csharp
// From any script, play sound effect
AudioManager.Instance.PlaySFX(seedSowingSound, volume: 0.8f);

// Play background music
AudioManager.Instance.PlayMusic(menuMusicClip, loop: true);

// Settings UI integration (Epic 5)
musicSlider.value = AudioManager.Instance.MusicVolume;
musicSlider.onValueChanged.AddListener(AudioManager.Instance.SetMusicVolume);
```

---

## Dev Notes

### Architecture References

**Manager Singleton Pattern:** [Source: architecture.md#8.2-unity-best-practices > Singleton Pattern]
- Follow standard singleton implementation with DontDestroyOnLoad
- Single instance across all scenes

**Audio System:** Architecture mentions AudioManager as required manager (Epic 1 deliverables)
- No detailed audio architecture document exists yet (will be created in Epic 7 polish phase)
- This story creates minimal viable audio system for MVP

**Performance Requirements:** [Source: architecture.md#9-performance-requirements]
- Audio playback must not impact 60 FPS target
- Use object pooling for SFX AudioSources to avoid runtime allocations

### Design Decisions

**Why Object Pooling for SFX:**
- Prevents instantiating/destroying AudioSources during gameplay (causes GC allocations)
- Pre-allocated pool of 10 AudioSources sufficient for Oware (turn-based, not action-heavy)
- Graceful degradation if pool exhausted (warning logged, oldest sound dropped)

**Why PlayerPrefs for Settings:**
- Simple persistence solution for MVP
- UGS Cloud Save integration deferred to Epic 4 (Progression Systems)
- Future: Migrate to Cloud Save for cross-device sync

**Music Fade Duration:**
- 0.5s default fade out prevents jarring audio cuts
- Uses DOTween for smooth volume interpolation

---

## Implementation Tasks

### Dev Agent Record

**Tasks:**

- [ ] **Task 1:** Create `Managers` folder: `Assets/_Project/Scripts/Managers/`
- [ ] **Task 2:** Implement `AudioManager.cs` with all required methods
- [ ] **Task 3:** Add AudioManager GameObject to Boot scene
- [ ] **Task 4:** Test singleton pattern (verify DontDestroyOnLoad works across scene loads)
- [ ] **Task 5:** Test PlaySFX with dummy AudioClip
- [ ] **Task 6:** Test PlayMusic with looping and stop with fade
- [ ] **Task 7:** Test volume controls (SetMusicVolume, SetSFXVolume)
- [ ] **Task 8:** Test mute toggles (SetMusicMuted, SetSFXMuted)
- [ ] **Task 9:** Test PlayerPrefs persistence (change settings, restart Unity, verify settings loaded)
- [ ] **Task 10:** Profile performance (verify no frame drops when playing SFX)
- [ ] **Task 11:** Test SFX pool exhaustion (play >10 sounds simultaneously, verify graceful handling)

**Debug Log:**
| Task | File | Change | Reverted? |
|------|------|--------|-----------|
|  |  |  |  |

**Completion Notes:**

<!-- Only note deviations from requirements, keep under 50 words -->

**Change Log:**

<!-- Only requirement changes during implementation -->

---

## Game Design Context

**GDD Reference:** Architecture > Core Manager Singletons

**Game Mechanic:** Audio System Foundation

**Player Experience Goal:**
- Responsive audio feedback enhances game feel
- Volume controls respect player preferences
- Persistent settings create seamless experience across sessions

**Balance Parameters:**

- **Default Music Volume:** 50% (0.5f) - background music shouldn't overpower gameplay
- **Default SFX Volume:** 100% (1.0f) - clear feedback for player actions
- **Max Simultaneous SFX:** 10 - sufficient for turn-based gameplay
- **Music Fade Duration:** 0.5 seconds - smooth transitions

---

## Testing Requirements

### Manual Testing

**Test Cases:**

1. **TC1: Singleton Pattern**
   - Start Boot scene
   - Load MainMenu scene
   - Expected: AudioManager persists, single instance exists
   - Check: Only one AudioManager in Hierarchy after scene load

2. **TC2: Play Sound Effect**
   - Call `AudioManager.Instance.PlaySFX(testClip)`
   - Expected: Sound plays clearly at correct volume
   - Performance: No frame drops

3. **TC3: Play Background Music**
   - Call `AudioManager.Instance.PlayMusic(testMusicClip, loop: true)`
   - Expected: Music loops continuously
   - Call `StopMusic(0.5f)`
   - Expected: Music fades out over 0.5 seconds

4. **TC4: Volume Controls**
   - Set music volume to 0.5, play music
   - Expected: Music at half volume
   - Set SFX volume to 0.2, play sound
   - Expected: SFX at 20% volume

5. **TC5: Mute Toggles**
   - Play music, set music muted = true
   - Expected: Music volume = 0 (silent)
   - Unmute, expected: Music audible again

6. **TC6: Settings Persistence**
   - Set music volume to 0.3, SFX muted = true
   - Exit play mode, re-enter play mode
   - Expected: Settings restored (music 0.3, SFX muted)

7. **TC7: SFX Pool Stress Test**
   - Play 15 sounds rapidly (exceeds pool size of 10)
   - Expected: Warning logged, no crashes, 10 sounds play

### Performance Tests

**Metrics to Verify:**

- Frame rate: 60 FPS maintained while playing music + multiple SFX
- Memory: No allocations during PlaySFX calls (object pool working)
- Audio latency: <50ms from PlaySFX call to sound start

---

## Dependencies

**Story Dependencies:**

- Story 1.1 (DOTween) - Required for music fade effects

**Technical Dependencies:**

- Boot scene exists (current status: âœ… Complete)
- DOTween package installed (Story 1.1)

**Asset Dependencies:**

- Test AudioClips (can use any .wav or .mp3 for testing, delete after verification)

---

## Definition of Done

- [ ] AudioManager singleton implemented with all methods
- [ ] AudioManager GameObject added to Boot scene
- [ ] Singleton pattern verified (persists across scenes)
- [ ] All audio playback methods tested (SFX, Music, Stop)
- [ ] Volume controls and mute toggles functional
- [ ] PlayerPrefs persistence verified
- [ ] Performance profiled (60 FPS, no allocations)
- [ ] SFX object pool tested (handles exhaustion gracefully)
- [ ] No console errors or warnings
- [ ] XML documentation complete on all public methods

---

## Notes

**Implementation Notes:**

- Use DOTween's `DOFade` for smooth music fade out (requires Story 1.1 complete)
- PlayerPrefs auto-saves on application quit, but manual `Save()` ensures immediate persistence
- AudioSource pool size (10) may need adjustment during Epic 7 polish if more complex sound layering added

**Design Decisions:**

- **Object Pooling:** Chosen to avoid GC allocations during gameplay (critical for 60 FPS target)
- **PlayerPrefs vs Cloud Save:** PlayerPrefs for MVP simplicity, Cloud Save deferred to Epic 4 for cross-device sync
- **Fade Duration:** 0.5s balances smooth transition vs responsiveness (not too slow)

**Future Considerations:**

- Epic 7: Add audio mixing groups (separate Music/SFX volume in Unity Audio Mixer)
- V1.1: Migrate settings to UGS Cloud Save for cross-device sync
- V1.2: Add audio ducking (lower music volume during SFX playback)

---

**Story Created:** 2025-10-21
**Last Updated:** 2025-10-21
**Created By:** Jordan (Game Scrum Master)
